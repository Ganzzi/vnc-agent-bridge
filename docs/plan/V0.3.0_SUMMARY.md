# WebSocket VNC Integration - Generic URL Template Support (v0.3.0)

**Document:** Comprehensive WebSocket Integration Analysis  
**Date:** October 27, 2025 (Revised - Generic Approach)
**Status:** Planning Complete - Ready for Implementation  
**Version:** v0.3.0

## Overview

VNC Agent Bridge v0.3.0 will add **WebSocket support with flexible URL templates** for VNC-over-WebSocket connections. Instead of Proxmox-specific integration, this provides a generic, extensible approach where users provide URL templates with `${}` placeholders.

**Key Design Principle:** Library is VNC server-agnostic. Users define the URL template for their WebSocket VNC server. Library handles only connection and RFB protocol.

### What This Enables
- ✅ **Proxmox** VNC WebSocket connections
- ✅ **Custom WebSocket** VNC servers (any implementation)
- ✅ **Private VNC** infrastructure with WebSocket
- ✅ **Cloud VNC** services that use WebSocket
- ✅ **Hybrid setups** mixing TCP and WebSocket

## What's Been Done (Planning Phase)

### 1. Complete Architecture Designed ✅
- **Connection Strategy Pattern:** Multiple transport types (TCP, WebSocket)
- **Generic WebSocket URLs:** Template-based URL patterns with `${}` placeholders
- **Backward Compatibility:** 100% compatible with v0.2.0 - no breaking changes
- **Type Safety:** All code 100% type-hinted with mypy --strict
- **Server-Agnostic:** Works with any WebSocket VNC server implementation

### 2. Three Comprehensive Documents Created ✅

#### Document 1: Integration Plan
- Complete WebSocket architecture overview
- URL template design and patterns
- Phased implementation approach
- Flexibility and extensibility details

#### Document 2: Technical Specification
- WebSocket protocol implementation with URL templates
- Parameter substitution mechanism (`${host}`, `${port}`, `${ticket}`)
- Code examples with Proxmox and custom servers
- Security best practices

#### Document 3: Implementation Checklist
- Task breakdown by phase
- Acceptance criteria
- Quality checkpoints and test coverage targets

## Architecture at a Glance

### Current (v0.2.0)
```
VNCAgentBridge
    ↓
VNCConnection (TCP socket)
    ↓
RFB Protocol
    ↓
TCP Socket (port 5900)
```

### With WebSocket Support (v0.3.0)
```
USER'S CODE (gets credentials from their VNC server provider)
    ↓
    Example: Proxmox API, custom cloud service, config file, etc.
    ↓
    Gets: host, port, ticket/token, certificate (if needed)
    ↓
    Passes params + URL template to VNC Agent Bridge
    ↓
VNCAgentBridge
    ↓
VNCConnectionBase (abstract)
    ├─ TCPVNCConnection (existing, refactored)
    │   └─ TCP Socket (port 5900)
    └─ WebSocketVNCConnection (new)
        └─ WebSocket over TLS (wss://)
        
WebSocketVNCConnection (server-agnostic)
    - Takes: host, port, ticket, cert, verify_ssl
    - Does: Creates wss:// connection with provided params
    - Benefit: Single responsibility, better security, more flexible
```

**Key Design Principle:** User/application handles Proxmox API calls and authentication. VNC Agent Bridge receives ready-to-use connection parameters.

## Design Principles ⭐

1. **Server-Agnostic** ⭐ **CRITICAL**
   - Library does NOT depend on specific VNC server (Proxmox, custom, etc.)
   - Users provide URL template with `${}` placeholders
   - Library just connects and handles RFB protocol
   - Benefits: Flexible, reusable, not vendor-locked

2. **URL Template Pattern:** `wss://${host}:${port}/path?ticket=${ticket}`
   - Users define the full URL template for their server
   - Library substitutes: `${host}`, `${port}`, `${ticket}`, `${password}` (if needed)
   - Simple string replacement, no magic

3. **Single Responsibility**: Library handles VNC protocol over WebSocket, not server integration

4. **Backward Compatible**: VNCConnection remains unchanged for existing TCP users

5. **Transport Agnostic**: Connection logic independent of TCP vs WebSocket

6. **Type Safe**: 100% type hints, mypy strict compliance

7. **Mock Testable**: No real server needed for tests (all mocked)

8. **Secure by Default**: TLS verification enabled, users control credentials

9. **Optional Dependency**: WebSocket support requires `websocket-client` library

## Key Integration Points

### 1. Separation of Concerns (Server-Specific Logic is User's Responsibility)
```
USER RESPONSIBILITY:
1. Get connection parameters from their VNC server
   (e.g., call Proxmox API, custom admin API, config file, etc.)
2. Define URL template for WebSocket connection
3. Pass parameters to library

LIBRARY RESPONSIBILITY:
1. Substitute `${}` placeholders in URL template
2. Create WebSocket connection to resulting URL
3. Handle RFB protocol handshake
4. Send/receive mouse and keyboard events
5. Manage connection lifecycle
```

**Benefits:**
- ✅ Not tied to any specific server
- ✅ Flexible for any WebSocket VNC implementation
- ✅ Credentials stay in user code
- ✅ Simpler to test and maintain
- ✅ No external API dependencies in library

### 2. URL Template Pattern

Users provide templates like:
```
wss://${host}:${port}/path/vncwebsocket?ticket=${ticket}
wss://${host}:${port}/api/vnc?token=${ticket}
wss://${host}:${port}/custom/websocket?pwd=${password}
wss://static.host:6900/qemu/${ticket}/websocket
```

Library substitutes:
- `${host}` → Connection host
- `${port}` → Connection port
- `${ticket}` → Auth ticket/token
- `${password}` → Auth password (optional)

### 3. Usage Patterns

**Standard VNC (unchanged):**
```python
from vnc_agent_bridge import VNCAgentBridge

with VNCAgentBridge('192.168.1.100') as vnc:
    vnc.mouse.left_click(100, 100)
    vnc.keyboard.type_text("hello")
```

**WebSocket VNC - Proxmox Example:**
```python
from vnc_agent_bridge.core import WebSocketVNCConnection
from vnc_agent_bridge import VNCAgentBridge
import requests

# User calls Proxmox API
response = requests.post(
    "https://proxmox.example.com:8006/api2/json/nodes/pve/qemu/100/vncproxy",
    headers={"Authorization": f"PVEAPIToken=root@pam!token=secret"},
)
proxy_info = response.json()['data']

# URL template with ${} placeholders
url_template = "wss://${host}:${port}/api2/json/nodes/pve/qemu/100/vncwebsocket?vncticket=${ticket}"

# Create WebSocket connection
ws_conn = WebSocketVNCConnection(
    url_template=url_template,
    host="proxmox.example.com",
    port=proxy_info['port'],
    ticket=proxy_info['ticket'],
    verify_ssl=True,
)

# Use with VNCAgentBridge
with VNCAgentBridge(connection=ws_conn) as vnc:
    vnc.connect()
    vnc.mouse.left_click(100, 100)
```

**WebSocket VNC - Custom Server Example:**
```python
from vnc_agent_bridge.core import WebSocketVNCConnection
from vnc_agent_bridge import VNCAgentBridge

# Custom server URL template
url_template = "wss://${host}/vnc/websocket?token=${ticket}"

ws_conn = WebSocketVNCConnection(
    url_template=url_template,
    host="custom-vnc.example.com",
    ticket="user_auth_token_here",
    verify_ssl=True,
)

with VNCAgentBridge(connection=ws_conn) as vnc:
    vnc.connect()
    vnc.mouse.left_click(100, 100)
```

**With convenience helper (optional):**
```python
from vnc_agent_bridge.core import create_websocket_vnc

url_template = "wss://${host}:${port}/vnc?ticket=${ticket}"

with create_websocket_vnc(
    url_template=url_template,
    host="vnc.example.com",
    port=6900,
    ticket="auth_ticket",
) as vnc:
    vnc.mouse.left_click(100, 100)
```

## Implementation Phases (3 Phases, 8-10 hours estimated)

### Phase 1: WebSocket Connection Implementation (4-5 hours)
**Objective:** Create architecture supporting multiple connection types

**Deliverables:**
- `VNCConnectionBase` abstract class
- `TCPVNCConnection` (refactored from existing)
- `WebSocketVNCConnection` (new, with URL template support)
- `VNCConnection` alias for backward compatibility
- Comprehensive unit tests

**Key Files:**
- `vnc_agent_bridge/core/base_connection.py` (new)
- `vnc_agent_bridge/core/connection_tcp.py` (refactored)
- `vnc_agent_bridge/core/connection_websocket.py` (new)
- `tests/test_*.py` (comprehensive)

### Phase 2: Convenience Helpers & Documentation (2-3 hours)
**Objective:** Simple helper functions and documentation

**Deliverables:**
- `create_websocket_vnc()` helper function
- Comprehensive documentation on URL template patterns
- Examples for multiple WebSocket VNC servers (Proxmox, custom, etc.)
- Unit tests with mocked WebSocket connections

**Key Files:**
- `vnc_agent_bridge/core/helpers.py` (new, or part of connection_websocket.py)
- `docs/guides/websocket_vnc.md` (new)
- `examples/websocket_examples.py` (new)

### Phase 3: Testing & Documentation (1-2 hours)
**Objective:** Quality assurance and comprehensive documentation

**Deliverables:**
- Complete test suite (85%+ coverage)
- API documentation
- Multiple usage examples for different WebSocket VNC servers
- Security best practices
- README updates

**Key Files:**
- `tests/test_websocket_*.py` (comprehensive)
- `docs/api/websocket_connection.md`
- `examples/websocket_*.py` (multiple examples)

## Quality Targets

### Code Quality
- ✅ 100% type hints (mypy --strict)
- ✅ Zero flake8 errors
- ✅ 100% black formatted
- ✅ 85%+ test coverage
- ✅ 100% backward compatible

### Testing Strategy
- Mock-based (no real WebSocket needed)
- Mock-based server API calls (no external servers needed)
- All v0.2.0 tests pass unchanged
- Comprehensive error scenarios
- 90%+ coverage for new code

### Documentation
- API documentation (600+ lines)
- Usage guide (1000+ lines)
- Working examples (3+ scripts)
- Architecture diagrams
- Security best practices
- Troubleshooting guide

## New Dependencies

### Added (Optional)
- **websocket-client** (~50KB)
  - Lightweight WebSocket client
  - Battle-tested library
  - Optional extra: `pip install vnc-agent-bridge[proxmox]`

### No Additional Core Dependencies
- HTTP API calls use `urllib` (stdlib)
- No new required dependencies
- Graceful error if websocket-client not installed

## Backward Compatibility

### Guaranteed ✅
- All v0.2.0 code works unchanged
- `VNCConnection` alias maintained
- No breaking changes to public API
- All existing controllers work identically
- VNCAgentBridge API unchanged

### Verification
- All v0.2.0 tests pass without modification
- Example: `VNCAgentBridge('localhost')` works exactly the same

## Security Considerations

### Default Secure
- ✅ TLS/SSL enabled by default (wss://)
- ✅ Certificate verification enabled
- ✅ No plaintext credentials in URLs
- ✅ Proxmox ticket-based auth (short-lived)

### Configuration Options
- `verify_ssl=True` (recommended, default)
- `verify_ssl=False` (development only)
- Custom certificate path support
- API token in constructor (not stored)

## Performance Impact

### Expected Overhead
- WebSocket protocol: ~5-10% overhead vs raw TCP
- TLS handshake: ~100-500ms (one-time)
- Frame wrapping: <1% overhead per message
- Proxmox API call: ~100-200ms (one-time)

### Optimization Opportunities
- Connection pooling (future)
- WebSocket compression (future)
- Frame batching (future)

## File Structure

```
vnc_agent_bridge/
├── core/
│   ├── base_connection.py        # NEW: Abstract base
│   ├── connection_tcp.py          # REFACTORED: TCP impl
│   ├── connection_websocket.py    # NEW: WebSocket impl (URL templates)
│   ├── bridge.py                  # UPDATED: Support base class
│   └── ... (unchanged files)
│
└── ... (unchanged)

tests/
├── test_base_connection.py        # NEW
├── test_websocket_connection.py   # NEW
└── ... (v0.2.0 tests unchanged)

docs/
├── guides/
│   └── websocket_vnc.md           # NEW: WebSocket usage guide
├── api/
│   └── websocket_connection.md    # NEW: WebSocketVNCConnection API
└── plan/
    ├── (planning documents)
    └── ...

examples/
├── proxmox_websocket.py           # NEW: Proxmox example
├── custom_websocket.py            # NEW: Custom server example
└── ...
```

**Key Change:** No `proxmox/` module needed. Everything in `core/` is server-agnostic with URL template support.

## Next Steps

### Immediate (Ready to Start)
1. Create VNCConnectionBase abstract class (`core/base_connection.py`)
2. Refactor existing VNCConnection to TCPVNCConnection
3. Implement WebSocketVNCConnection with URL template support
4. Create comprehensive tests and verify 

### If Starting Today
- Estimated completion: 1-2 days (working 4-6 hours per day)
- All planning documents available
- Implementation checklist ready

## Risk Mitigation

### Technical Risks
| Risk | Mitigation | Confidence |
|------|-----------|-----------|
| WebSocket edge cases | Use battle-tested library, comprehensive mocks | High |
| Proxmox API variations | Mock various responses, document assumptions | High |
| TLS certificate issues | Configurable verification, clear errors | High |
| Dependency conflicts | Optional dependency, clear installation guide | High |

### Adoption Risks
| Risk | Mitigation | Confidence |
|------|-----------|-----------|
| User confusion | Clear documentation, examples, guides | High |
| Breaking changes | 100% backward compatible design | Very High |
| Performance impact | WebSocket overhead acceptable (~5-10%) | High |

## Documentation Provided

### Three Main Planning Documents
1. **PROXMOX_INTEGRATION_PLAN.md** (5000+ words)
   - Complete strategy and architecture
   - Design decisions with rationale
   - Risk analysis
   
2. **PROXMOX_TECHNICAL_SPEC.md** (3000+ words)
   - Detailed implementation examples
   - Code snippets
   - Configuration options
   
3. **PROXMOX_IMPLEMENTATION_CHECKLIST.md** (2000+ words)
   - Task-by-task breakdown
   - Acceptance criteria
   - Quality checkpoints

### Ready for Implementation
- ✅ Architecture designed
- ✅ Detailed specifications written
- ✅ Implementation checklist created
- ✅ Test strategy defined
- ✅ Documentation planned
- ✅ Risk analysis completed

## Conclusion

The Proxmox WebSocket VNC integration is **fully planned and ready for implementation**. The design:

1. **Maintains 100% backward compatibility** - existing code works unchanged
2. **Follows established patterns** - Strategy pattern for extensibility
3. **Provides user-friendly API** - Simple ProxmoxVNCBridge wrapper
4. **Ensures quality** - 85%+ coverage, 100% type hints, comprehensive tests
5. **Is well documented** - Planning docs + implementation guide ready

The integration enables AI agents to control Proxmox VMs through secure WebSocket connections while preserving all existing functionality.

**Status:** ✅ **Ready to implement**  
**Estimated effort:** 12-16 hours  
**Documentation:** Complete  
**Risk level:** Low  
**Confidence:** Very High  

---

## Contact & Support

For questions about this integration plan:
- Review the three planning documents in detail
- Check the implementation checklist for specific tasks
- Refer to technical specification for code examples
- Follow the phased approach for incremental development

All documentation is in: `docs/plan/`

